<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Server Slot Tracker</title>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px; }
    #controls div { display: flex; gap: 8px; }
    #controls input { flex: 1; padding: 4px 8px; }
    #controls button { padding: 4px 8px; }
    .grids { display: grid; grid-template-columns: repeat(6, 60px); grid-auto-rows: 80px; gap: 8px; margin-bottom: 24px; }
    .slot { position: relative; border: 1px solid #ccc; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; background-color: #e0ffe0; transition: background-color 0.2s; }
    .slot.in-use    { background-color: lightcoral; }
    .slot.done      { background-color: lightblue; }
    .slot.inactive  { background-color: lightgray; }
    .slot .content  { font-size: 14px; font-weight: bold; }
    .slot .timer    { position: absolute; bottom: 4px; font-size: 12px; font-weight: bold; }
  </style>
</head>
<body>
  <div id="controls">
    <div>
      <input id="uploaderInput" placeholder="Uploader name…">
      <button id="beginLogging">Begin Logging</button>
      <button id="finishLogging">Finish Logging</button>
    </div>
    <div>
      <input id="collectorInput" placeholder="Collector name…">
      <button id="beginCollecting">Begin Collecting</button>
      <button id="finishCollecting">Finish Collecting</button>
    </div>
    <div>
      <button id="logAll">Log All</button>
      <button id="collectAll">Collect All</button>
    </div>
  </div>

  <h2>Room 440</h2>
  <div id="grids-440" class="grids"></div>

  <h2>Room 255 - Full Grid</h2>
  <div id="grids-255a" class="grids"></div>

  <h2>Room 255 - Row of 6</h2>
  <div id="grids-255b" class="grids"></div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const DURATION = 30 * 1000;
    const POLL_INTERVAL = 1000;
    const LOG_URL = 'https://script.google.com/macros/s/AKfycbyvlorG-cm0PLCrkzl0BZeHeSIwXdBWu3U4ElBI8zMbaz_h96TK0e3l88wNDWcmNl3JMw/exec';

    // Central slot state
    const slots = {};
    let mode = null; // 'upload' | 'collect'

    // Input mode handlers
    document.getElementById('beginLogging').onclick = () => { mode = 'upload'; };
    document.getElementById('finishLogging').onclick = () => { mode = null; };
    document.getElementById('beginCollecting').onclick = () => { mode = 'collect'; };
    document.getElementById('finishCollecting').onclick = () => { mode = null; };

    function logEvent(action, id) {
      const user = (mode === 'upload' ? document.getElementById('uploaderInput').value.trim() :
                   mode === 'collect' ? document.getElementById('collectorInput').value.trim() :
                   null);
      if (!action || !user) return;
      const [room, slot] = id.split('-');
      new URLSearchParams({ action, room, slot, user });
      fetch(`${LOG_URL}?action=${action}&room=${room}&slot=${slot}&user=${encodeURIComponent(user)}`)
        .catch(console.error);
    }

    function createSlot(id, container) {
      const el = document.createElement('div');
      el.className = 'slot';
      el.innerHTML = `<div class="content">${id}</div><div class="timer"></div>`;
      container.appendChild(el);
      slots[id] = { id, el, state: 'idle', end: 0 };
      el.addEventListener('click', () => handleClick(id));
    }

    function handleClick(id) {
      const s = slots[id];
      if (mode === 'upload') {
        s.end = Date.now() + DURATION;
        s.state = 'in-use';
        updateSlotUI(s);
        logEvent('upload_started', id);
      } else if (mode === 'collect' && s.state === 'done') {
        s.state = 'idle';
        s.end = 0;
        updateSlotUI(s);
        logEvent('collected', id);
      }
    }

    function updateSlotUI(s) {
      s.el.classList.remove('in-use', 'done', 'inactive');
      s.el.querySelector('.timer').textContent = '';
      if (s.state === 'in-use') s.el.classList.add('in-use');
      else if (s.state === 'done') s.el.classList.add('done');
      else if (s.state === 'inactive') s.el.classList.add('inactive');
    }

    // Generate grids
    const rows = ['A','B','C','D','E','F'];
    function generateGrids() {
      const r440 = document.getElementById('grids-440');
      for (let srv=1; srv<=6; srv++) rows.forEach(r => {
        for (let i=1; i<=6; i++) createSlot(`440S${srv}-${r}${i}`, r440);
      });
      const r255a = document.getElementById('grids-255a');
      rows.forEach(r => { for (let i=1; i<=6; i++) createSlot(`255A-${r}${i}`, r255a); });
      const r255b = document.getElementById('grids-255b');
      for (let i=1; i<=6; i++) createSlot(`255B-A${i}`, r255b);
    }
    generateGrids();

    // Master timer loop
    function masterTick() {
      const now = Date.now();
      for (const s of Object.values(slots)) {
        if (s.state === 'in-use') {
          const rem = s.end - now;
          if (rem <= 0) {
            s.state = 'done';
            s.end = 0;
            updateSlotUI(s);
            logEvent('upload_done', s.id);
          } else {
            s.el.querySelector('.timer').textContent = Math.ceil(rem/1000) + 's';
          }
        }
      }
    }
    setInterval(masterTick, 500);

    // Collect All atomic snapshot
    document.getElementById('collectAll').onclick = () => {
      const doneSlots = Object.values(slots).filter(s => s.state === 'done');
      doneSlots.forEach(s => {
        s.state = 'idle';
        s.end = 0;
        updateSlotUI(s);
        logEvent('collected', s.id);
      });
    };

    // Log All
    document.getElementById('logAll').onclick = () => {
      const now = Date.now();
      Object.values(slots).forEach(s => {
        if (s.state === 'idle') {
          s.state = 'in-use'; s.end = now + DURATION;
          updateSlotUI(s);
          logEvent('upload_started', s.id);
        }
      });
    };

    // Polling refresh, skip active/done
    function refreshState() {
      fetch(`${LOG_URL}?mode=getState`)
        .then(r => r.json())
        .then(state => {
          const now = Date.now();
          Object.entries(state).forEach(([id, {status, end}]) => {
            const s = slots[id];
            if (!s || s.state === 'in-use' || s.state === 'done') return;
            if (status === 'in-use') {
              s.state = 'in-use'; s.end = end;
            } else if (status === 'done') {
              s.state = 'done'; s.end = 0;
            } else if (status === 'inactive') {
              s.state = 'inactive'; s.end = 0;
            }
            updateSlotUI(s);
          });
        }).catch(console.error);
    }
    setInterval(refreshState, POLL_INTERVAL);
  });
  </script>
</body>
</html>
