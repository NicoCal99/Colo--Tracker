<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Server Slot Tracker</title>
  <style>
    body { font-family: sans-serif; padding: 16px; position: relative; }
    #controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 8px; }
    #controls div { display: flex; flex-direction: column; gap: 4px; }
    #controls input, #controls button { padding: 4px 8px; }

    #summary { text-align: right; margin-bottom: 8px; font-size: 14px; }
    #summary div { margin: 2px 0; }
    #next-list { text-align: right; font-size: 13px; margin-bottom: 16px; }
    #next-list div { margin: 2px 0; }

    #extra-controls { position: absolute; top: 16px; right: 16px; display: grid; grid-template-columns: 1fr; gap: 4px; font-size: 12px; }
    #extra-controls input, #extra-controls button { padding: 2px 6px; }

    .row-group { display: flex; gap: 32px; margin-bottom: 32px; }
    .server-wrapper { display: flex; flex-direction: column; align-items: center; }
    .server-wrapper h3 { margin: 0 0 8px; font-size: 16px; }

    .grids { display: grid; grid-template-columns: repeat(6, 60px); grid-auto-rows: 180px; gap: 8px; }
    .slot { position: relative; border: 1px solid #ccc; border-radius: 4px;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      cursor: pointer; background-color: #e0ffe0; transition: background-color 0.2s;
      width: 60px; height: 180px; }
    .slot.in-use    { background-color: lightcoral; }
    .slot.done      { background-color: lightblue; }
    .slot.inactive  { background-color: lightgray; }
    .slot .content  { font-size: 14px; font-weight: bold; text-align: center; }
    .slot .timer    { position: absolute; bottom: 4px; font-size: 12px; font-weight: bold; }
  </style>
</head>
<body>
  <div id="controls">
    <div>
      <input id="uploaderInput" placeholder="Uploader name…">
      <button id="beginLogging">Begin Logging</button>
      <button id="finishLogging">Finish Logging</button>
    </div>
    <div>
      <input id="collectorInput" placeholder="Collector name…">
      <button id="beginCollecting">Begin Collecting</button>
      <button id="finishCollecting">Finish Collecting</button>
    </div>
    <div>
      <input id="activatorInput" placeholder="Activator name…">
      <button id="beginActivating">Begin Activate</button>
      <button id="finishActivating">Finish Activate</button>
      <input id="deactivatorInput" placeholder="Deactivator name…">
      <button id="beginDeactivating">Begin Deactivate</button>
      <button id="finishDeactivating">Finish Deactivate</button>
    </div>
  </div>

  <div id="summary">
    <div id="global-count">Total Ready: 0</div>
    <div id="count-440">440 Ready: 0</div>
    <div id="count-255">255 Ready: 0</div>
  </div>
  <div id="next-list">
    <div><strong>Next Slots:</strong></div>
  </div>

  <h2>Room 440</h2>
  <div id="wrapper-440">
    <div class="row-group" id="row1-440"></div>
    <div class="row-group" id="row2-440"></div>
  </div>

  <h2>Room 255</h2>
  <div class="row-group">
    <div class="server-wrapper">
      <h3>SERVER S1</h3>
      <div id="grids-255a" class="grids"></div>
    </div>
    <div class="server-wrapper">
      <h3>SERVER S2</h3>
      <div id="grids-255b" class="grids"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const DURATION = 30 * 1000;
      const LOG_URL = 'https://script.google.com/macros/s/AKfycbyvlorG-cm0PLCrkzl0BZeHeSIwXdBWu3U4ElBI8zMbaz_h96TK0e3l88wNDWcmNl3JMw/exec';
      const slots = {};
      let mode = null;

      // Helper to require name
      function requireName(inputId, modeName) {
        const name = document.getElementById(inputId).value.trim();
        if (!name) alert(`Enter ${modeName} name.`);
        return name;
      }

      // Begin handlers: require name and ensure no other mode active
      document.getElementById('beginLogging').onclick = () => {
        if (!requireName('uploaderInput', 'Uploader') || mode) {
          if (mode) alert(`Finish ${mode} first.`);
          return;
        }
        mode = 'upload';
      };
      document.getElementById('finishLogging').onclick = () => {
        if (mode !== 'upload') return alert('Not in logging mode.');
        mode = null;
      };
      document.getElementById('beginCollecting').onclick = () => {
        if (!requireName('collectorInput', 'Collector') || mode) {
          if (mode) alert(`Finish ${mode} first.`);
          return;
        }
        mode = 'collect';
      };
      document.getElementById('finishCollecting').onclick = () => {
        if (mode !== 'collect') return alert('Not in collecting mode.');
        mode = null;
      };
      document.getElementById('beginActivating').onclick = () => {
        if (!requireName('activatorInput', 'Activator') || mode) {
          if (mode) alert(`Finish ${mode} first.`);
          return;
        }
        mode = 'activate';
      };
      document.getElementById('finishActivating').onclick = () => {
        if (mode !== 'activate') return alert('Not in activating mode.');
        mode = null;
      };
      document.getElementById('beginDeactivating').onclick = () => {
        if (!requireName('deactivatorInput', 'Deactivator') || mode) {
          if (mode) alert(`Finish ${mode} first.`);
          return;
        }
        mode = 'deactivate';
      };
      document.getElementById('finishDeactivating').onclick = () => {
        if (mode !== 'deactivate') return alert('Not in deactivating mode.');
        mode = null;
      };

      // Log event
      function logEvent(action, room, slot, user) {
        const params = new URLSearchParams({ action, room, slot, user });
        params.append('_', Date.now());
        fetch(`${LOG_URL}?${params}`, {cache:'no-cache'}).catch(console.error);
      }

      // Create slots
      function createSlot(id, container) {
        const el = document.createElement('div'); el.className='slot';
        el.innerHTML = `<div class="content">${id}</div><div class="timer"></div>`;
        container.appendChild(el);
        slots[id] = { id, el, state:'idle', end:0 };
        el.onclick = () => {
          const [rid,srv,sli] = id.split('-'); const room=`${rid}-${srv}`;
          const name =
            mode==='upload'? requireName('uploaderInput','Uploader') :
            mode==='collect'? requireName('collectorInput','Collector') :
            mode==='activate'? requireName('activatorInput','Activator') :
            mode==='deactivate'? requireName('deactivatorInput','Deactivator') : null;
          if (!name) return;
          if (mode==='upload')      { slots[id].state='in-use'; slots[id].end=Date.now()+DURATION; updateUI(slots[id]); logEvent('upload_started',room,sli,name); }
          else if (mode==='collect' && slots[id].state==='done') { slots[id].state='idle'; slots[id].end = 0; updateUI(slots[id]); logEvent('collected',room,sli,name); slots[id].state='idle'; updateUI(slots[id]); logEvent('collected',room,sli,name); }
          else if (mode==='activate') { slots[id].end = 0; slots[id].state='idle'; updateUI(slots[id]); logEvent('activated',room,sli,name);   { slots[id].state='idle'; updateUI(slots[id]); logEvent('activated',room,sli,name); }
          else if (mode==='deactivate') { slots[id].state='inactive'; slots[id].end = 0; updateUI(slots[id]); logEvent('inactivated', room, sli, name); { slots[id].state='inactive'; updateUI(slots[id]); logEvent('inactivated', room, sli, name); }
          updateCounts();
          updateNext();
        };
      }

      function updateUI(s) {
        s.el.classList.remove('in-use','done','inactive');
        s.el.querySelector('.timer').textContent='';
        if (s.state==='in-use')    s.el.classList.add('in-use');
        if (s.state==='done')      s.el.classList.add('done');
        if (s.state==='inactive')  s.el.classList.add('inactive');
      }

      // Counts summary
      function updateCounts() {
        let g=0,c440=0,c255=0;
        Object.values(slots).forEach(s=>{
          if (s.state==='done') {
            g++; const rid=s.id.split('-')[0]; if (rid==='440') c440++; else if (rid==='255') c255++;
          }
        });
        document.getElementById('global-count').textContent=`Total Ready: ${g}`;
        document.getElementById('count-440').textContent=`440 Ready: ${c440}`;
        document.getElementById('count-255').textContent=`255 Ready: ${c255}`;
      }

      // Top 5 next
      function updateNext() {
        const now=Date.now();
        const arr = Object.values(slots)
          .filter(s=>s.state==='in-use')
          .map(s=>({id:s.id, rem:s.end-now}))
          .filter(o=>o.rem>0)
          .sort((a,b)=>a.rem-b.rem)
          .slice(0,5);
        const container = document.getElementById('next-list');
        container.innerHTML = '<div><strong>Next Slots:</strong></div>';
        arr.forEach(o=>{
          const div=document.createElement('div');
          div.textContent=`${o.id} → ${Math.ceil(o.rem/1000)}s`;
          container.appendChild(div);
        });
      }

      // Init grids
      const rows=['A','B','C','D','E','F'];
      function initGrids(){
        const r1=document.getElementById('row1-440');
        const r2=document.getElementById('row2-440');
        for(let s=1;s<=6;s++){
          const wrapper=document.createElement('div'); wrapper.className='server-wrapper';
          const head=document.createElement('h3'); head.textContent=`SERVER S${s}`; wrapper.appendChild(head);
          const grid=document.createElement('div'); grid.className='grids'; wrapper.appendChild(grid);
          (s<=3?r1:r2).appendChild(wrapper);
          rows.forEach(r=>{for(let i=1;i<=6;i++){createSlot(`440-S${s}-${r}${i}`,grid);}});
        }
        const ga=document.getElementById('grids-255a'); rows.forEach(r=>{for(let i=1;i<=6;i++){createSlot(`255-S1-${r}${i}`,ga);}});
        const gb=document.getElementById('grids-255b'); for(let i=1;i<=6;i++){createSlot(`255-S2-B${i}`,gb);}  }
      initGrids();

      // Refresh state
      function refreshState(){
        fetch(`${LOG_URL}?mode=getState&_=${Date.now()}`,{cache:'no-cache'})
          .then(r=>r.json()).then(data=>{
            Object.values(slots).forEach(s=>{
              const [rid,srv,sli]=s.id.split('-');
              const key=`${rid}-${srv}-${sli}`;
              const e = data[key];
              if(e && e.status){
                // only set state when a non-empty status exists
                s.state = e.status;
                s.end   = e.end;
              } else {
                // clear state for collected or missing entries
                s.state = 'idle';
                s.end   = 0;
              }
              updateUI(s);
            });
            updateCounts();
            updateNext();
          }).catch(console.error);
      }
      refreshState();

      // Timer and live next updates
      setInterval(()=>{
        const now=Date.now(); let changed=false;
        Object.values(slots).forEach(s=>{
          if(s.state==='in-use'){
            const rem=s.end-now;
            if(rem<=0){ s.state='done'; s.end = 0; updateUI(s); const [rid,srv,sli]=s.id.split('-'); logEvent('upload_done', `${rid}-${srv}`, sli, ''); changed=true; }
            else s.el.querySelector('.timer').textContent=`${Math.ceil(rem/1000)}s`;
          }
        });
        if(changed) updateCounts();
        updateNext();
      },500);
    });
  </script>
</body>
</html>
