<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Server Slot Tracker</title>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px; }
    #controls div { display: flex; gap: 8px; }
    #controls input { flex: 1; padding: 4px 8px; }
    #controls button { padding: 4px 8px; }
    .grids { display: grid; grid-template-columns: repeat(6, 60px); grid-auto-rows: 80px; gap: 8px; margin-bottom: 24px; }
    .slot { position: relative; border: 1px solid #ccc; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; background-color: #e0ffe0; transition: background-color 0.2s; }
    .slot.in-use    { background-color: lightcoral; }
    .slot.done      { background-color: lightblue; }
    .slot.inactive  { background-color: lightgray; }
    .slot .content  { font-size: 14px; font-weight: bold; }
    .slot .timer    { position: absolute; bottom: 4px; font-size: 12px; font-weight: bold; }
  </style>
</head>
<body>
  <div id="controls">
    <div>
      <input id="uploaderInput" placeholder="Uploader name…">
      <button id="beginLogging">Begin Logging</button>
      <button id="finishLogging">Finish Logging</button>
    </div>
    <div>
      <input id="collectorInput" placeholder="Collector name…">
      <button id="beginCollecting">Begin Collecting</button>
      <button id="finishCollecting">Finish Collecting</button>
    </div>
    <div>
      <input id="inactivatorInput" placeholder="Inactivator name…">
      <button id="markInactive">Mark Inactive</button>
      <button id="finishInactivating">Finish Inactivating</button>
    </div>
    <div>
      <input id="activatorInput" placeholder="Activator name…">
      <button id="markActive">Mark Active</button>
      <button id="finishActivating">Finish Activating</button>
    </div>
  </div>

  <h2>Room 440</h2>
  <div id="grids-440" class="grids"></div>
  <h2>Room 255</h2>
  <div id="grids-255" class="grids"></div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const DURATION = 30 * 1000;
    const POLL_INTERVAL = 1000;
    const LOG_URL = 'https://script.google.com/macros/s/AKfycbyvlorG-cm0PLCrkzl0BZeHeSIwXdBWu3U4ElBI8zMbaz_h96TK0e3l88wNDWcmNl3JMw/exec';

    const rooms = ['440', '255'];
    const rows  = ['A','B','C','D','E','F'];
    const slots = {};
    const seen  = {};  // track timers started
    const collectedCache = new Set();
    const localOverrideUntil = {};

    let uploader = '', collector = '', inactivator = '', activator = '';

    document.getElementById('beginLogging').onclick = () => { uploader = document.getElementById('uploaderInput').value.trim(); };
    document.getElementById('finishLogging').onclick = () => { uploader = ''; };
    document.getElementById('beginCollecting').onclick = () => { collector = document.getElementById('collectorInput').value.trim(); };
    document.getElementById('finishCollecting').onclick = () => { collector = ''; };
    document.getElementById('markInactive').onclick = () => { inactivator = document.getElementById('inactivatorInput').value.trim(); };
    document.getElementById('finishInactivating').onclick = () => { inactivator = ''; };
    document.getElementById('markActive').onclick = () => { activator = document.getElementById('activatorInput').value.trim(); };
    document.getElementById('finishActivating').onclick = () => { activator = ''; };

    function logEvent(action, id, customUser = null) {
      const user = customUser || uploader || collector || inactivator || activator;
      if (!action || !user) return;
      const [room, slot] = id.split('-');
      const params = new URLSearchParams({ action, room, slot, user });
      fetch(`${LOG_URL}?${params}`).catch(console.error);
    }

    function setOverride(id, duration = 3000) {
      localOverrideUntil[id] = Date.now() + duration;
    }

    function createSlot(id, container) {
      const el = document.createElement('div');
      el.className = 'slot';
      el.innerHTML = `<div class="content">${id}</div><div class="timer"></div>`;
      container.appendChild(el);
      el.onclick = () => handleClick(id);
      slots[id] = { id, el, end: 0, iv: null, status: 'idle' };
    }

    function clearTimer(s) {
      if (s.iv) {
        clearInterval(s.iv);
        s.iv = null;
      }
    }

    function startTimer(s) {
      clearTimer(s);
      seen[s.id] = true;
      s.status = 'in-use';
      s.el.classList.remove('done','inactive');
      s.el.classList.add('in-use');

      function tick() {
        const rem = s.end - Date.now();
        if (rem <= 0) {
          clearTimer(s);
          s.el.classList.remove('in-use');
          s.el.classList.add('done');
          s.el.querySelector('.timer').textContent = '';
          delete seen[s.id];
          s.status = 'done';
          logEvent('upload_done', s.id);
        } else {
          s.el.querySelector('.timer').textContent = Math.ceil(rem/1000) + 's';
        }
      }
      tick();
      s.iv = setInterval(tick, 1000);
    }

    function handleClick(id) {
      const s = slots[id];
      if (uploader) {
        s.end = Date.now() + DURATION;
        s.status = 'in-use';
        logEvent('upload_started', id, uploader);
        setOverride(id);
        startTimer(s);
      } else if (collector && s.status === 'done') {
        if (!collectedCache.has(id)) {
          collectedCache.add(id);
          s.status = 'collected';
          setOverride(id);
          s.el.classList.remove('done','in-use','inactive');
          s.el.querySelector('.timer').textContent = '';
          clearTimer(s);
          logEvent('collected', id);
        }
      } else if (inactivator && s.status !== 'in-use' && s.status !== 'done') {
        s.el.classList.add('inactive');
        s.status = 'inactive';
        setOverride(id);
        logEvent('inactivated', id);
      } else if (activator && s.status === 'inactive') {
        s.el.classList.remove('inactive');
        s.status = 'idle';
        setOverride(id);
        logEvent('activated', id);
      }
    }

    rooms.forEach(room => {
      const container = document.getElementById(`grids-${room}`);
      rows.forEach(row => { for (let i=1; i<=6; i++) createSlot(`${room}-${row}${i}`, container); });
    });

    function refreshState() {
      fetch(`${LOG_URL}?mode=getState`)
        .then(r=>r.json())
        .then(state=>{
          Object.entries(state).forEach(([id,{status,end}])=>{
            if (localOverrideUntil[id] && Date.now() < localOverrideUntil[id]) return;
            const s = slots[id]; if(!s) return;

            if(seen[id] && status !== 'in-use'){
              clearTimer(s);
              delete seen[id];
            }

            s.status = status;
            s.el.classList.remove('in-use','done','inactive');
            s.el.querySelector('.timer').textContent = '';

            if(status==='in-use'){
              s.el.classList.add('in-use');
              s.end = end;
              if(!s.iv) startTimer(s);
            }
            else if(status==='done') {
              s.el.classList.add('done');
              collectedCache.delete(id);
            }
            else if(status==='inactive') s.el.classList.add('inactive');
          });
        }).catch(console.error);
    }

    refreshState();
    setInterval(refreshState, POLL_INTERVAL);
  });
  </script>
</body>
</html>
