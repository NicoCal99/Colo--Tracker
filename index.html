<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Server Slot Tracker</title>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px; }
    #controls div { display: flex; gap: 8px; align-items: center; }
    #controls input, #controls button { padding: 4px 8px; }

    #summary { text-align: right; margin-bottom: 16px; font-size: 14px; }
    #summary div { margin: 2px 0; }
    #next-list { text-align: right; margin-bottom: 24px; font-size: 13px; }
    #next-list div { margin: 2px 0; }

    .row-group { display: flex; gap: 32px; margin-bottom: 32px; }
    .server-wrapper { display: flex; flex-direction: column; align-items: center; }
    .server-wrapper h3 { margin: 0 0 8px; }

    .grids { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
    .slot { position: relative; padding: 8px; border: 1px solid #ccc; border-radius: 4px;
      cursor: pointer; background: #eee; display: flex; flex-direction: column; align-items: center; }
    .slot.in-use { background: lightcoral; }
    .slot.done   { background: lightgreen; }
    .slot.inactive { background: lightgray; }
    .timer { position: absolute; bottom: 4px; font-size: 12px; }
  </style>
</head>
<body>
  <div id="controls">
    <div>
      <input id="uploader" placeholder="Uploader…" />
      <button id="logStart">Start Log</button>
      <button id="logEnd">End Log</button>
    </div>
    <div>
      <input id="collector" placeholder="Collector…" />
      <button id="colStart">Start Collect</button>
      <button id="colEnd">End Collect</button>
    </div>
  </div>
  <div id="summary">
    <div id="total">Total Ready: 0</div>
    <div id="r440">440: 0</div>
    <div id="r255">255: 0</div>
  </div>
  <div id="next-list"><div><strong>Next:</strong></div></div>

  <h2>440</h2>
  <div id="r440-wrap" class="row-group"></div>

  <h2>255</h2>
  <div id="r255-wrap" class="row-group"></div>

  <script>
    document.addEventListener('DOMContentLoaded',()=>{
      const D=30000,URL='https://script.google.com/macros/s/AKfycbyvlorG-cm0PLCrkzl0BZeHeSIwXdBWu3U4ElBI8zMbaz_h96TK0e3l88wNDWcmNl3JMw/exec';
      const slots={},mode=null;
      let curMode=null,curUser='';
      function bind(start,end,input,act){
        document.getElementById(start).onclick=()=>{ const u=document.getElementById(input).value.trim(); if(!u||curMode) return; curMode=act;curUser=u; };
        document.getElementById(end).onclick=()=>{ if(curMode!==act) return; curMode=null;curUser=''; };
      }
      bind('logStart','logEnd','uploader','upload_started');
      bind('colStart','colEnd','collector','collected');

      function fetchState(){
        fetch(URL+'?mode=getState&_='+Date.now()).then(r=>r.json()).then(data=>{
          Object.entries(slots).forEach(([id,s])=>{
            const e=data[id]||{status:'',end:0};
            s.state=e.status;s.end=e.end;update(s);
          }); summary(); next();
        }).catch(console.error);
      }

      function act(id){ if(!curMode) return; const s=slots[id];
        const [r,sv,sl]=id.split('-');
        if(curMode==='upload_started'){s.state='in-use';s.end=Date.now()+D; post(curMode,r,sv,sl,curUser);} else if(curMode==='collected'&&s.state==='done'){s.state='idle';s.end=0; post(curMode,r,sv,sl,curUser);} update(s); summary(); next();
      }

      function post(a,r,sv,sl,u){ fetch(`${URL}?action=${a}&room=${r}&server=${sv}&slot=${sl}&user=${u}`,{cache:'no-cache'}); }
      function update(s){ const c=s.el; c.classList.remove('in-use','done','inactive'); c.querySelector('.timer').textContent=''; if(s.state==='in-use') c.classList.add('in-use'); if(s.state==='done') c.classList.add('done'); if(s.state==='inactive') c.classList.add('inactive'); }

      function summary(){ let t=0,c1=0,c2=0; Object.values(slots).forEach(s=>{if(s.state==='done'){t++;if(s.id.startsWith('440'))c1++;else c2++;}});
        document.getElementById('total').textContent=`Total Ready: ${t}`;
        document.getElementById('r440').textContent=`440: ${c1}`;
        document.getElementById('r255').textContent=`255: ${c2}`;
      }
      function next(){ const now=Date.now(); const arr=Object.values(slots).filter(s=>s.state==='in-use').map(s=>({id:s.id,rem:s.end-now})).filter(o=>o.rem>0).sort((a,b)=>a.rem-b.rem).slice(0,5);
        const c=document.getElementById('next-list'); c.innerHTML='<div><strong>Next:</strong></div>'; arr.forEach(o=>{const d=document.createElement('div');d.textContent=`${o.id} → ${Math.ceil(o.rem/1000)}s`;c.appendChild(d);}); }

      function tick(){ const now=Date.now(); let ch=false; Object.values(slots).forEach(s=>{if(s.state==='in-use'){const rem=s.end-now; if(rem<=0){s.state='done';s.end=0;update(s);const [r,sv,sl]=s.id.split('-'); post('upload_done',r,sv,sl,''); ch=true;} else s.el.querySelector('.timer').textContent=`${Math.ceil(rem/1000)}s`;}}); if(ch) summary(); next(); }

      function init(room,wrap,servers){ servers.forEach(s=>{const div=document.createElement('div');div.className='grids';wrap.appendChild(div); ['A','B','C','D','E','F'].forEach(r=>{ for(let i=1;i<=6;i++){const id=`${room}-${s}-${r}${i}`; const el=document.createElement('div'); el.className='slot'; el.innerHTML=`<div class="content">${id}</div><div class="timer"></div>`; div.appendChild(el); slots[id]={id,el,state:'idle',end:0}; el.onclick=()=>act(id); }});});}

      init('440',document.getElementById('r440-wrap'),['S1','S2','S3','S4','S5','S6']);
      init('255',document.getElementById('r255-wrap'),['S1','S2']);

      fetchState(); setInterval(fetchState,5000); setInterval(tick,500);
    });
  </script>
</body>
</html>
